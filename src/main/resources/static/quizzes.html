<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mis Quizzes - Sinergia</title>
    <script>
        (function () {
            const token = localStorage.getItem('jwtToken');
            if (!token) { window.location.href = 'login.html'; return; }

            function parseJwt(t) {
                try {
                    const base64Url = t.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                    return JSON.parse(jsonPayload);
                } catch (e) { return null; }
            }

            const payload = parseJwt(token);
            if (payload && payload.role && payload.role.toUpperCase() === 'ADMIN') {
                window.location.href = 'dashboard-admin.html';
            }
        })();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Serif+Display&display=swap');
        :root { --primary: #ff6200; --white: #fff; --bg: #f4f4f4; --dark: #333; --success: #28a745; --danger: #dc3545; --primary-color: #ff6200; --white-color: #fff; --dark-text: #333; --light-bg: #f4f4f4; --grey-border: #ddd; --secondary-color: #007bff; }
        body { font-family: Calibri, "Segoe UI", Arial, sans-serif; background: var(--bg); margin: 0; min-height: 100vh; color: var(--dark-text); display: flex; flex-direction: column; }
        
        /* --- Navbar (copiado de dashboard-estudiante) --- */
        nav.navbar {
            background-color: var(--white-color);
            padding: 1rem 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .navbar .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            text-decoration: none;
            display: flex; align-items: center;
        }
        .navbar .logo img { height: 70px; width: auto; margin-right: 0.5rem; }
        .navbar .nav-links {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }
        .navbar .nav-links a {
            text-decoration: none;
            color: var(--dark-text);
            font-weight: 500;
            transition: color 0.3s ease;
        }
        .navbar .nav-links a:hover, .navbar .nav-links a.active {
            color: var(--primary-color);
        }

        /* Dropdown */
        .dropdown { position: relative; display: inline-block; }
        .dropdown-content { 
            display: none; 
            position: absolute; 
            background-color: var(--white-color); 
            min-width: 160px; 
            box-shadow: 0 8px 16px rgba(0,0,0,0.1); 
            z-index: 1001; 
            border-radius: 5px; 
            margin-top: 0.5rem; 
        }
        .dropdown-content a { 
            color: var(--dark-text); 
            padding: 12px 16px; 
            text-decoration: none; 
            display: block; 
        }
        .dropdown-content a:hover { 
            background-color: var(--light-bg); 
            color: var(--primary-color); 
        }
        .dropdown.open .dropdown-content { display: block; }
        .dropdown .dropbtn { cursor: pointer; text-decoration: none; color: var(--dark-text); font-weight: 500; background: none; border: none; font-family: inherit; font-size: inherit; }
        .dropdown .dropbtn:hover { color: var(--primary-color); }

        /* User Section */
        .user-section { display: flex; align-items: center; gap: 1rem; }
        .user-info-mini { display: flex; align-items: center; gap: 0.6rem; }
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            font-weight: bold;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        .user-name-mini { font-weight: 500; font-size: 0.95rem; }
        .button-logout {
            padding: 0.5rem 1rem; border: 1px solid var(--primary-color); background: transparent; color: var(--primary-color); border-radius: 5px; cursor: pointer; font-weight: bold; text-decoration: none; font-size: 0.9rem;
        }
        .button-logout:hover { background: var(--primary-color); color: white; }
        .button-edit-profile {
            padding: 0.5rem 1rem;
            border: 1px solid var(--primary-color);
            background: var(--primary-color);
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            font-size: 0.85rem;
            transition: background 0.2s ease;
        }
        .button-edit-profile:hover { background: #d65100; }

        /* Layout */
        .main-container { display: flex; flex: 1; min-height: calc(100vh - 80px); }

        .sidebar { width: 250px; background: var(--white); border-right: 1px solid #ddd; padding: 1.5rem; overflow-y: auto; }
        .content { flex: 1; padding: 2rem; position: relative; }

        /* Sidebar Buttons */
        .topic-btn { width: 100%; padding: 10px; border: none; background: none; text-align: left; cursor: pointer; border-radius: 5px; display: flex; justify-content: space-between; margin-bottom: 5px; }
        .topic-btn:hover { background: #eee; }
        .topic-btn.active { background: #ffe6cc; color: var(--primary); font-weight: bold; }
        .badge { background: #ddd; padding: 2px 6px; border-radius: 10px; font-size: 0.8rem; }

        /* Grid & Cards */
        .quiz-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; }
        .quiz-card { background: var(--white); padding: 1.5rem; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); transition: transform 0.2s; border-top: 5px solid var(--primary); position: relative; }
        .quiz-card:hover { transform: translateY(-5px); }
        h1, h2, h3, h4 { font-family: 'DM Serif Display', serif; }

        .quiz-title { margin: 0 0 0.5rem 0; font-size: 1.2rem; }
        .quiz-meta { font-size: 0.9rem; color: #666; margin-bottom: 1rem; }
        .btn { padding: 0.6rem 1.2rem; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; background: var(--primary); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); cursor: pointer; padding: 0.6rem 1.2rem; border-radius: 5px; }
        .delete-icon { position: absolute; top: 10px; right: 10px; cursor: pointer; color: #ccc; }
        .delete-icon:hover { color: var(--danger); }

        /* CREATION FORM STYLES */
        #view-create { display: none; max-width: 800px; margin: 0 auto; background: var(--white); padding: 2rem; border-radius: 10px; }
        .question-block { background: #f9f9f9; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #eee; }
        .option-row { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }

        /* GAME MODE STYLES */
        #view-game { display: none; max-width: 700px; margin: 0 auto; text-align: center; }
        .game-question { font-size: 1.5rem; margin-bottom: 2rem; }
        .game-options { display: grid; gap: 1rem; }
        .game-btn { padding: 1rem; background: var(--white); border: 2px solid #eee; border-radius: 8px; cursor: pointer; font-size: 1.1rem; transition: all 0.2s; }
        .game-btn:hover { border-color: var(--primary); background: #fff8f0; }
        .game-btn.correct { background-color: var(--success); color: white; border-color: var(--success); }
        .game-btn.wrong { background-color: var(--danger); color: white; border-color: var(--danger); }

        /* --- Footer --- */
        footer {
            background-color: #1e1e1e;
            color: var(--white-color);
            padding: 3.5rem 8% 2rem;
            margin-top: 3rem;
        }

        .footer-content {
            display: flex;
            flex-wrap: wrap;
            gap: 2.5rem;
            justify-content: space-between;
            margin-bottom: 2rem;
        }

        .footer-column {
            flex: 1 1 220px;
            min-width: 200px;
        }

        .footer-column h4 {
            font-family: 'DM Serif Display', serif;
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .footer-column p {
            margin: 0.25rem 0;
            font-size: 0.95rem;
        }

        .footer-links {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .footer-links li {
            margin-bottom: 0.4rem;
        }

        .footer-links a {
            color: var(--white-color);
            text-decoration: none;
            font-size: 0.95rem;
            opacity: 0.85;
        }

        .footer-links a:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .footer-bottom {
            border-top: 1px solid rgba(255,255,255,0.12);
            padding-top: 1.5rem;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            font-size: 0.9rem;
        }

        .footer-social {
            display: flex;
            gap: 1rem;
        }

        .footer-social a {
            color: var(--white-color);
            text-decoration: none;
            font-size: 0.95rem;
            opacity: 0.85;
        }

        .footer-social a:hover {
            opacity: 1;
        }

    </style>
</head>
<body>

    <nav class="navbar">
        <a href="#" class="logo" onclick="goToDashboardSegunRol()">
             <img src="/images/1.png" alt="Sinergia Logo">
        </a>
        
        <ul class="nav-links">
            <li><a href="#" onclick="goToDashboardSegunRol()">Inicio</a></li>
            <li><a href="recursos.html">Recursos Educativos</a></li>
            <li><a href="marketplace.html">Marketplace de Tutores</a></li>
            <li class="dropdown">
                <a href="#" class="dropbtn">Repaso Activo &#9662;</a>
                <div class="dropdown-content">
                    <a href="flashcards.html">Flashcards</a>
                    <a href="quizzes.html" class="active">Quizzes</a>
                    <a href="planificador.html">Planificador</a>
                </div>
            </li>
        </ul>

        <div class="user-section">
            <div class="user-info-mini">
                <div class="user-avatar" id="user-avatar"></div>
                <span id="user-name" class="user-name-mini"></span>
            </div>
            <button type="button" class="button-edit-profile" onclick="irAPerfil()">Editar perfil</button>
            <a href="#" onclick="logout()" class="button-logout">Cerrar SesiÃ³n</a>
        </div>
    </nav>

    <div class="main-container">
        <aside class="sidebar" id="sidebar">
            <h3>ðŸ“š Materias</h3>
            <div id="topics-list"></div>
        </aside>

        <main class="content">
            
            <div id="view-list">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
                    <h1 id="page-title" style="margin:0;">Mis Quizzes</h1>
                    <button class="btn" onclick="showCreateView()">+ Crear Quiz</button>
                </div>
                <div id="quiz-grid" class="quiz-grid">
                    <p>Cargando...</p>
                </div>
            </div>

            <div id="view-create">
                <h2 style="margin-top:0;">Crear Nuevo Quiz</h2>
                <div style="margin-bottom:1rem;">
                    <input type="text" id="quiz-title" placeholder="TÃ­tulo del Quiz (Ej. MatemÃ¡ticas BÃ¡sicas)" style="font-size:1.2rem; margin-bottom:0.5rem;">
                    
                    <input type="text" id="quiz-desc" placeholder="DescripciÃ³n del Quiz (Ej: Repaso para el parcial)" style="margin-bottom: 10px;">
                    
                    <input type="text" id="quiz-materia" placeholder="Materia (Ej. MatemÃ¡ticas)" list="materias-sugeridas">
                    <datalist id="materias-sugeridas"></datalist>
                </div>
                
                <div id="questions-container"></div>
                
                <button class="btn-outline" onclick="addQuestionBlock()" style="width:100%; margin:1rem 0;">+ Agregar Pregunta</button>
                
                <div style="text-align:right; gap:10px; display:flex; justify-content:flex-end;">
                    <button class="btn-outline" onclick="showListView()">Cancelar</button>
                    <button class="btn" onclick="saveQuiz()">Guardar Quiz</button>
                </div>
            </div>

            <div id="view-game">
                <h2 id="game-materia" style="color:#666; font-size:1rem; text-transform:uppercase;"></h2>
                <div class="game-question" id="game-question-text"></div>
                <div class="game-options" id="game-options-container"></div>
                <p id="game-score" style="margin-top:2rem; font-weight:bold; font-size:1.2rem;"></p>
                <button id="btn-next-q" class="btn" style="margin-top:1rem; display:none;" onclick="nextQuestion()">Siguiente</button>
                <button id="btn-finish" class="btn" style="margin-top:1rem; display:none;" onclick="showListView()">Volver al inicio</button>
            </div>

        </main>
    </div>

    <script>
        // AsegÃºrate de que esta es la clave correcta que usaste en login.html (token o jwtToken)
        const token = localStorage.getItem('token') || localStorage.getItem('jwtToken');
        if (!token) window.location.href = 'login.html';

        let allQuizzes = [];
        let currentFilter = 'TODAS';
        let activeQuiz = null;
        let currentQuestionIndex = 0;
        let score = 0;

        document.addEventListener('DOMContentLoaded', loadData);

        document.addEventListener('DOMContentLoaded', () => {
            const jwt = localStorage.getItem('jwtToken');
            if (jwt) {
                const payload = parseJwt(jwt);
                if (payload) {
                    const nombreBase = payload.sub ? payload.sub.split('@')[0] : 'Usuario';
                    const nombreCapitalizado = nombreBase.charAt(0).toUpperCase() + nombreBase.slice(1);
                    const userNameSpan = document.getElementById('user-name');
                    if (userNameSpan) {
                        userNameSpan.textContent = nombreCapitalizado;
                    }
                }
            }
            cargarPerfilUsuarioNavbar();
        });

        async function loadData() {
            try {
                const res = await fetch('http://localhost:8080/api/quizzes', {
                    headers: { 'Authorization': 'Bearer ' + token }
                });
                if (res.ok) {
                    allQuizzes = await res.json();
                    renderSidebar();
                    renderQuizzes('TODAS');
                } else {
                    console.error("Error cargando quizzes");
                }
            } catch (e) { console.error(e); }
        }

        // --- RENDERIZADO ---
        function renderSidebar() {
            const sidebar = document.getElementById('topics-list');
            const datalist = document.getElementById('materias-sugeridas');
            const counts = {};
            
            allQuizzes.forEach(q => {
                let m = q.materia ? capitalize(q.materia) : 'General';
                counts[m] = (counts[m] || 0) + 1;
            });

            sidebar.innerHTML = `<button class="topic-btn active" onclick="filterBy('TODAS', this)">Todas <span class="badge">${allQuizzes.length}</span></button>`;
            datalist.innerHTML = '';

            Object.keys(counts).sort().forEach(m => {
                sidebar.innerHTML += `<button class="topic-btn" onclick="filterBy('${m}', this)">${m} <span class="badge">${counts[m]}</span></button>`;
                datalist.innerHTML += `<option value="${m}">`;
            });
        }

        function renderQuizzes(filter) {
            const grid = document.getElementById('quiz-grid');
            grid.innerHTML = '';
            
            const filtered = allQuizzes.filter(q => {
                let m = q.materia ? capitalize(q.materia) : 'General';
                return filter === 'TODAS' || m === filter;
            });

            if(filtered.length === 0) {
                grid.innerHTML = '<p style="color:#777;">No hay quizzes disponibles.</p>';
                return;
            }

            filtered.forEach(q => {
                // ProtecciÃ³n contra nulos
                const numPreguntas = (q.preguntas) ? q.preguntas.length : 0;
                
                grid.innerHTML += `
                    <div class="quiz-card">
                        <span class="delete-icon" onclick="deleteQuiz(${q.id})">&times;</span>
                        <div class="quiz-title">${q.titulo}</div>
                        <div class="quiz-meta">${q.materia || 'General'} â€¢ ${numPreguntas} Preguntas</div>
                        <div style="font-size:0.8rem; color:#888; margin-bottom:10px;">${q.descripcion || ''}</div>
                        <button class="btn" onclick='startQuiz(${JSON.stringify(q)})'>Comenzar Quiz</button>
                    </div>
                `;
            });
        }

        function filterBy(materia, btnElement) {
            currentFilter = materia;
            document.querySelectorAll('.topic-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');
            document.getElementById('page-title').textContent = materia === 'TODAS' ? 'Mis Quizzes' : materia;
            renderQuizzes(materia);
        }

        // --- LÃ“GICA DE CREACIÃ“N ---
        function showCreateView() {
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-create').style.display = 'block';
            document.getElementById('questions-container').innerHTML = '';
            
            // Limpiar inputs
            document.getElementById('quiz-title').value = '';
            document.getElementById('quiz-desc').value = '';
            document.getElementById('quiz-materia').value = '';
            
            addQuestionBlock(); 
        }

        function showListView() {
            document.getElementById('view-create').style.display = 'none';
            document.getElementById('view-game').style.display = 'none';
            document.getElementById('view-list').style.display = 'block';
            loadData();
        }

        function addQuestionBlock() {
            const container = document.getElementById('questions-container');
            const index = container.children.length + 1;
            
            // CORRECCIÃ“N 3: Usar las clases correctas (input-pregunta, input-opcion)
            const html = `
                <div class="question-block">
                    <label><strong>Pregunta ${index}:</strong></label>
                    <input type="text" class="input-pregunta" placeholder="Escribe la pregunta..." style="margin-bottom:10px;">
                    
                    <div class="options-list">
                        ${[1,2,3,4].map(i => `
                            <div class="option-row">
                                <input type="radio" name="correct-${index}" ${i===1?'checked':''}>
                                <input type="text" class="input-opcion" placeholder="OpciÃ³n ${i}">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        }

        async function saveQuiz() {
            // CORRECCIÃ“N 4: IDs coinciden con el HTML ahora
            const titulo = document.getElementById('quiz-title').value;
            const descripcion = document.getElementById('quiz-desc').value; 
            const materia = document.getElementById('quiz-materia').value;

            if (!titulo || !materia) {
                alert("Por favor completa el tÃ­tulo y la materia");
                return;
            }

            const preguntasElements = document.querySelectorAll('.question-block');
            const preguntas = [];

            preguntasElements.forEach(block => {
                // CORRECCIÃ“N 5: Selectores coinciden con addQuestionBlock
                const textoPregunta = block.querySelector('.input-pregunta').value;
                const opcionesElements = block.querySelectorAll('.option-row');
                const opciones = [];

                opcionesElements.forEach(row => {
                    const textoOpcion = row.querySelector('.input-opcion').value;
                    const esCorrecta = row.querySelector('input[type="radio"]').checked;
                    
                    if(textoOpcion) {
                        opciones.push({ textoOpcion: textoOpcion, esCorrecta: esCorrecta });
                    }
                });

                if(textoPregunta && opciones.length > 0) {
                    preguntas.push({ 
                        textoPregunta: textoPregunta, 
                        opciones: opciones 
                    });
                }
            });

            const quizData = {
                titulo: titulo,
                descripcion: descripcion,
                materia: materia,
                preguntas: preguntas
            };

            try {
                const response = await fetch('http://localhost:8080/api/quizzes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + token
                    },
                    body: JSON.stringify(quizData)
                });

                if (response.ok) {
                    alert("Â¡Quiz guardado exitosamente!");
                    showListView();
                } else {
                    alert("Error al guardar el quiz. Verifica la consola.");
                    console.error(await response.text());
                }
            } catch (e) {
                console.error(e);
                alert("Error de conexiÃ³n");
            }
        }

        // --- JUGAR ---
        function startQuiz(quiz) {
            if (!quiz.preguntas || quiz.preguntas.length === 0) {
                alert("âš ï¸ Este quiz no tiene preguntas cargadas.");
                return;
            }

            activeQuiz = quiz;
            currentQuestionIndex = 0;
            score = 0;
            
            document.getElementById('view-list').style.display = 'none';
            document.getElementById('view-game').style.display = 'block';
            document.getElementById('game-materia').textContent = quiz.materia;
            document.getElementById('btn-finish').style.display = 'none';
            document.getElementById('game-score').textContent = '';
            
            showGameQuestion();
        }

        function showGameQuestion() {
            const q = activeQuiz.preguntas[currentQuestionIndex];
            document.getElementById('game-question-text').textContent = q.textoPregunta;
            const optContainer = document.getElementById('game-options-container');
            document.getElementById('btn-next-q').style.display = 'none';
            
            optContainer.innerHTML = '';
            q.opciones.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'game-btn';
                btn.textContent = opt.textoOpcion;
                btn.onclick = () => selectAnswer(btn, opt.esCorrecta);
                optContainer.appendChild(btn);
            });
        }

        function selectAnswer(btn, isCorrect) {
            const allBtns = document.querySelectorAll('.game-btn');
            allBtns.forEach(b => b.onclick = null); // Bloquear clicks

            if(isCorrect) {
                btn.classList.add('correct');
                score++;
            } else {
                btn.classList.add('wrong');
            }

            if(currentQuestionIndex < activeQuiz.preguntas.length - 1) {
                document.getElementById('btn-next-q').style.display = 'inline-block';
            } else {
                const finalBtn = document.getElementById('btn-finish');
                finalBtn.style.display = 'inline-block';
                finalBtn.textContent = "Finalizar - Ver Resultado";
                finalBtn.onclick = showResults;
            }
        }

        function nextQuestion() {
            currentQuestionIndex++;
            showGameQuestion();
        }

        function showResults() {
            const total = activeQuiz.preguntas.length;
            const percent = Math.round((score / total) * 100);
            let msg = percent >= 60 ? "Â¡Buen trabajo! ðŸŽ‰" : "Sigue practicando ðŸ“š";
            
            document.getElementById('game-question-text').innerHTML = `<h1>Puntaje: ${score} / ${total}</h1><h3>${percent}%</h3><p>${msg}</p>`;
            document.getElementById('game-options-container').innerHTML = '';
            
            const finalBtn = document.getElementById('btn-finish');
            finalBtn.textContent = "Volver a mis Quizzes";
            finalBtn.onclick = showListView;
            finalBtn.style.display = 'inline-block';
        }

        async function deleteQuiz(id) {
            if(confirm("Â¿Eliminar este quiz?")) {
                await fetch(`http://localhost:8080/api/quizzes/${id}`, { 
                    method: 'DELETE', 
                    headers: { 'Authorization': 'Bearer ' + token } 
                });
                loadData();
            }
        }

        function capitalize(s) { return s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : ''; }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(window.atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) { return null; }
        }

        function goToDashboardSegunRol() {
            const jwt = localStorage.getItem('jwtToken');
            if (!jwt) { window.location.href = 'login.html'; return; }
            const payload = parseJwt(jwt);
            const role = payload && payload.role ? payload.role.toUpperCase() : 'ESTUDIANTE';

            if (role === 'ADMIN') {
                window.location.href = 'dashboard-admin.html';
            } else if (role === 'TUTOR') {
                window.location.href = 'dashboard-tutor.html';
            } else {
                window.location.href = 'dashboard-estudiante.html';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('jwtToken');
            window.location.href = 'index.html';
        }
    </script>

    <script>
        async function cargarPerfilUsuarioNavbar() {
            try {
                const jwt = localStorage.getItem('jwtToken');
                if (!jwt) return;

                const resp = await fetch('http://localhost:8080/api/auth/mi-perfil', {
                    headers: { 'Authorization': 'Bearer ' + jwt }
                });

                if (!resp.ok) return;

                const data = await resp.json();
                const avatar = document.getElementById('user-avatar');
                const nameSpan = document.getElementById('user-name');

                if (data && data.nombre) {
                    const nombreCompleto = data.apellido ? `${data.nombre} ${data.apellido}` : data.nombre;
                    if (nameSpan && !nameSpan.textContent) {
                        nameSpan.textContent = nombreCompleto;
                    }
                }

                if (avatar) {
                    if (data && data.fotoPerfil) {
                        avatar.style.backgroundImage = `url('${data.fotoPerfil}')`;
                        avatar.textContent = '';
                    } else {
                        const baseNombre = (data && data.nombre) ? data.nombre : (nameSpan ? nameSpan.textContent : '');
                        if (baseNombre) {
                            const partes = baseNombre.split(' ');
                            let iniciales = partes[0].charAt(0).toUpperCase();
                            if (partes.length > 1) {
                                iniciales += partes[1].charAt(0).toUpperCase();
                            }
                            avatar.textContent = iniciales;
                            avatar.style.backgroundImage = '';
                        }
                    }
                }
            } catch (e) {
                console.error('Error cargando perfil de usuario en navbar', e);
            }
        }

        function irAPerfil() {
            const token = localStorage.getItem('jwtToken');
            if (!token) { window.location.href = 'login.html'; return; }
            const payload = parseJwt(token);
            const role = payload && payload.role ? payload.role.toUpperCase() : 'ESTUDIANTE';

            if (role === 'ADMIN') {
                window.location.href = 'dashboard-admin.html';
            } else if (role === 'TUTOR') {
                window.location.href = 'dashboard-tutor.html';
            } else {
                window.location.href = 'dashboard-estudiante.html';
            }
        }
    </script>

    <footer>
        <div class="footer-content">
            <div class="footer-column">
                <h4>Sinergia</h4>
                <p>Plataforma LMS que conecta estudiantes, tutores y recursos en un solo lugar.</p>
                <p>Aprende de forma mÃ¡s inteligente, organizada y colaborativa.</p>
            </div>
            <div class="footer-column">
                <h4>Enlaces rÃ¡pidos</h4>
                <ul class="footer-links">
                    <li><a href="index.html">Inicio</a></li>
                    <li><a href="#">Marketplace de tutores</a></li>
                    <li><a href="#">Flashcards y quizzes</a></li>
                    <li><a href="#">Planificador</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h4>Contacto</h4>
                <p>soporte@sinergia.com</p>
                <p>+57 (000) 000 0000</p>
                <p>BogotÃ¡, Colombia</p>
            </div>
            <div class="footer-column">
                <h4>SÃ­guenos</h4>
                <div class="footer-social">
                    <a href="#">Instagram</a>
                    <a href="#">LinkedIn</a>
                    <a href="#">YouTube</a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <span>&copy; 2025 Sinergia. Todos los derechos reservados.</span>
            <span>TÃ©rminos y condiciones Â· PolÃ­tica de privacidad</span>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const dropdown = document.querySelector('.navbar .dropdown');
            if (!dropdown) return;

            const button = dropdown.querySelector('.dropbtn');
            const content = dropdown.querySelector('.dropdown-content');

            if (!button || !content) return;

            button.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                dropdown.classList.toggle('open');
            });

            content.addEventListener('click', function (e) {
                e.stopPropagation();
            });

            document.addEventListener('click', function () {
                dropdown.classList.remove('open');
            });
        });
    </script>

</body>
</html>